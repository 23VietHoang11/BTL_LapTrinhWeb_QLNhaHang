@model IEnumerable<RestaurantManagement.Models.Entities.DatBan>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <link rel="stylesheet" href="~/admin/css/admin.css">
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-logo">
            <img src="~/admin/images/cutlery.png" alt="Logo"> <span>Hi Anh Admin</span>
        </div>
        <ul class="main-menu">
            <li class="menu-item active" data-target="dashboard"><span class="icon"></span> Dashboard</li>
        </ul>
        <div class="sidebar-header">Quản lý danh sách</div>
        <ul class="main-menu">
            <li class="menu-item has-submenu" data-target="menuContent">
                <span class="icon">🍴</span> Quản Lý Món Ăn <span class="arrow">▶</span>
                <ul class="submenu">
                    <li class="menu-item" data-target="menuList">Danh sách món ăn</li>
                    <li class="menu-item" data-target="menuCategories">Danh mục sản phẩm</li>
                    <li class="menu-item" data-target="menuAdd">Thêm món ăn mới</li>
                </ul>
            </li>
            <li class="menu-item" data-target="tableBookingContent"><span class="icon">🪑</span> Quản Lý Đặt Bàn</li>
            <li class="menu-item" data-target="invoiceContent"><span class="icon">🧾</span> Quản Lý Hóa Đơn</li>
            <li class="menu-item" data-target="#"><span class="icon">🏠</span> Quản Lý Kho</li>
            <li class="menu-item" data-target="postContent"><span class="icon">📄</span> Quản Lý Bài Viết</li>
            <li class="menu-item has-submenu" data-target="roleContent">
                <span class="icon">🧑‍⚖️</span> Quản Lý Vai Trò <span class="arrow">▶</span>
                <ul class="submenu">
                    <li class="menu-item" data-target="roleList">Danh sách vai trò</li>
                    <li class="menu-item" data-target="rolePermissions">Phân quyền</li>
                </ul>
            </li>
            <li class="menu-item has-submenu" data-target="otherContent">
                <span class="icon">⚙️</span> Quản Lý Khác <span class="arrow">▶</span>
                <ul class="submenu">
                    <li class="menu-item" data-target="settingGeneral">Cài đặt chung</li>
                    <li class="menu-item" data-target="settingAdvanced">Cài đặt nâng cao</li>
                </ul>
            </li>
            <li class="menu-item has-submenu" data-target="staffContent">
                <span class="icon">👥</span> Quản Lý Tài khoản <span class="arrow">▶</span>
                <ul class="submenu">
                    <li class="menu-item" data-target="staffList">Danh sách tài khoản</li>
                    <li class="menu-item" data-target="staffAddEdit">Thêm/Sửa tài khoản</li>
                </ul>
            </li>
        </ul>
        <div class="sidebar-header">Tư vấn</div>
        <ul class="main-menu">
            <li class="menu-item" data-target="supportContent"><span class="icon">💬</span> Tư vấn với khách hàng</li>
        </ul>
    </div>

    <div class="main-content">

        <header>
            <div class="header-left">
                <button class="toggle-sidebar">☰</button>
                <h1 id="page-title">Dashboard</h1>
            </div>
            <div class="user-info">
                <span class="user-name">Đỗ Hoàng Hiếu</span>
                <img src="#" alt="Avatar" class="user-avatar">
            </div>
        </header>

        <div class="dashboard content-wrapper active" id="dashboard">
        </div>

        <div class="content-wrapper" id="menuList">
        </div>

        <div class="content-wrapper" id="menuCategories">
        </div>

        <div class="content-wrapper" id="menuAdd">
        </div>

        <div class="content-wrapper" id="postContent">
        </div>

        <div class="content-wrapper" id="settingGeneral">
        </div>

        <div class="content-wrapper" id="settingAdvanced">
        </div>


        <div class="content-wrapper" id="staffList">
            <h2>Danh sách tài khoản</h2>
            <div class="toolbar">
                <input type="text" id="staff-search-input" placeholder="Tìm kiếm tài khoản ở đây!" class="search-input">
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>TÊN ĐẦY ĐỦ</th>
                            <th>EMAIL</th>
                            <th>SĐT</th>
                            <th>VAI TRÒ</th>
                            <th>NGÀY SINH</th>
                            <th>SỐ CCCD</th>
                            <th>GIỚI TÍNH</th>
                            <th>THAO TÁC</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <span>Số lượng mục</span>
                <select id="staff-items-per-page">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
                <div class="pages">
                </div>
            </div>
        </div>

        <div class="content-wrapper" id="staffAddEdit">
            <h2>Thêm/Sửa tài khoản</h2>
            <div class="menu-details">
                <input type="hidden" id="staff-id" value="">

                <div class="form-group">
                    <label for="staff-username">Tên đăng nhập (*)</label>
                    <input type="text" id="staff-username" placeholder="hieudohoang">
                </div>
                <div class="form-group">
                    <label for="staff-password">Mật khẩu (*)</label>
                    <input type="password" id="staff-password" placeholder="Nhập để tạo mới hoặc thay đổi">
                    <small>Để trống nếu không muốn đổi mật khẩu khi cập nhật.</small>
                </div>
                <div class="form-group">
                    <label for="staff-name">Tên nhân viên (*)</label>
                    <input type="text" id="staff-name" placeholder="Đỗ Hoàng Hiếu">
                </div>
                <div class="form-group">
                    <label for="staff-email">Email</label>
                    <input type="email" id="staff-email" placeholder="abc123@gmail.com">
                </div>
                <div class="form-group">
                    <label for="staff-phone">Số điện thoại</label>
                    <input type="text" id="staff-phone" placeholder="0123456789">
                </div>
                <div class="form-group">
                    <label for="staff-dob">Ngày sinh (*)</label>
                    <input type="date" id="staff-dob" name="dateOfBirth" required>
                </div>
                <div class="form-group">
                    <label for="staff-cccd">Số CCCD (*)</label>
                    <input type="text" id="staff-cccd" placeholder="1234565667">
                </div>
                <div class="form-group">
                    <label for="staff-gender">Giới tính (*)</label>
                    <select id="staff-gender">
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="staff-address">Địa chỉ</label>
                    <input type="text" id="staff-address" placeholder="Hà Nội">
                </div>
                <div class="form-group">
                    <label for="staff-role">Chức vụ (*)</label>
                    <select id="staff-role">
                        <option value="Quản Lý">Quản Lý</option>
                        <option value="Bếp trưởng">Bếp trưởng</option>
                        <option value="Bếp phó">Bếp phó</option>
                        <option value="Phục vụ">Phục vụ</option>
                        <option value="Thu ngân">Thu ngân</option>
                        <option value="Bảo vệ">Bảo vệ</option>
                    </select>
                </div>

                <button id="btn-add" class="btn-primary">Thêm nhân viên</button>
                <button id="btn-update" class="btn-warning">Cập nhật thông tin</button>
                <button id="btn-delete" class="btn-danger">Xóa nhân viên</button>
            </div>
        </div>

        <div class="content-wrapper" id="tableBookingContent">
            <h2>Lịch đặt bàn</h2>
            <div class="booking-cards">
                @* Bắt đầu vòng lặp hiển thị dữ liệu từ Model *@
                @foreach (var datBan in Model)
                {
                    <div class="booking-card">
                        <h3>@(datBan.IdkhachHangNavigation?.HoTenKh ?? "Khách vãng lai") - @datBan.IddatBan.ToString("D9")</h3>
                        <div class="booking-details">
                            <p>⏰ @datBan.ThoiGian.ToString("HH:mm dd/MM/yyyy")</p>
                            <p>👥 @datBan.SoLuongKh</p>
                            <p>📝 @datBan.GhiChu</p>
                            <p>✨ <strong>@datBan.TrangThai</strong></p>
                        </div>
                        <button class="confirm-btn">Khách nhận bàn</button>
                        @* Thêm các nút thao tác khác như Sửa, Hủy... *@
                    </div>
                }
                @* Kết thúc vòng lặp *@
            </div>
        </div>

        <div class="content-wrapper" id="invoiceContent">
        </div>

        <div class="content-wrapper" id="roleList">
        </div>

        <div class="content-wrapper" id="rolePermissions">
        </div>

        <div class="content-wrapper" id="supportContent">
        </div>

    </div>
    
    <script>
        // --- BIẾN TOÀN CỤC ĐỂ LƯU TRỮ DỮ LIỆU ---
        let allStaffData = []; // Mảng chứa TẤT CẢ nhân viên
        let currentPage = 1;
        let itemsPerPage = 5; // Giá trị mặc định

        // --- HÀM HELPER (TOÀN CỤC) ---

        /**
         * Hàm này VẼ LẠI bảng và CÁC NÚT PHÂN TRANG
      
         */
        function renderStaffListAndPagination(dataToRender, page) {
            currentPage = page;
            const tableBody = document.querySelector('#staffList table tbody');
            const paginationContainer = document.querySelector('#staffList .pages');
            if (!tableBody || !paginationContainer) return;

            tableBody.innerHTML = '';
            paginationContainer.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedItems = dataToRender.slice(start, end);

            paginatedItems.forEach(nv => {
                let ngaySinhFormatted = '';
                if (nv.ngaySinh) {
                    try {
                        ngaySinhFormatted = new Date(nv.ngaySinh).toLocaleDateString('vi-VN');
                    } catch (e) {
                        ngaySinhFormatted = nv.ngaySinh;
                    }
                }

                const row = `
                    <tr>
                        <td>${nv.hoTen}</td>
                        <td>${nv.email || ''}</td>
                        <td>${nv.sdt || ''}</td>
                        <td><span class="badge role-type">${nv.chucVu || ''}</span></td>
                        <td>${ngaySinhFormatted}</td>
                        <td>${nv.cccd || ''}</td>
                        <td>${nv.gioiTinh || ''}</td>
                        <td class="actions">
                            <button class="btn-edit" data-id="${nv.id}">Sửa</button>
                            <button class="btn-delete-list" data-id="${nv.id}">Xóa</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            const pageCount = Math.ceil(dataToRender.length / itemsPerPage);

            paginationContainer.innerHTML += `<button data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;
            for (let i = 1; i <= pageCount; i++) {
                paginationContainer.innerHTML += `<button data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }
            paginationContainer.innerHTML += `<button data-page="${currentPage + 1}" ${currentPage === pageCount ? 'disabled' : ''}>&gt;</button>`;
        }


        /**
         * Tải danh sách nhân viên từ API và VẼ TRANG ĐẦU TIÊN
         */
        async function loadDanhSachNhanVien() {
            try {
                const response = await fetch('/api/nhanvien');
                if (!response.ok) {
                    alert("Không thể tải danh sách nhân viên."); return;
                }

                allStaffData = await response.json();

                const selectElement = document.getElementById('staff-items-per-page');
                if (selectElement) itemsPerPage = parseInt(selectElement.value, 10);

                // HÀM GỌI CHÍNH
                renderStaffListAndPagination(allStaffData, 1);

            } catch (err) {
                // LỖI XẢY RA Ở ĐÂY (nếu renderStaffListAndPagination bị lỗi)
                alert("Lỗi tải danh sách: " + err.message);
                allStaffData = [];
            }
        }

        /**
         * Tải thông tin chi tiết của 1 nhân viên và điền vào form "Sửa"
         
         */
        async function loadNhanVienDeSua(id) {
            try {
                const response = await fetch(`/api/nhanvien/${id}`);
                if (!response.ok) {
                    alert("Không thể tải thông tin nhân viên."); return;
                }
                const data = await response.json();

                document.getElementById('staff-id').value = data.idnhanVien;
                document.getElementById('staff-username').value = data.tenDangNhap;
                document.getElementById('staff-name').value = data.hoTenNv;
                document.getElementById('staff-email').value = data.email;
                document.getElementById('staff-phone').value = data.sdt;
                document.getElementById('staff-dob').value = data.ngaySinh ? data.ngaySinh.split('T')[0] : "";
                document.getElementById('staff-cccd').value = data.cccd;
                document.getElementById('staff-gender').value = data.gioiTinh;
                document.getElementById('staff-address').value = data.diaChi;
                document.getElementById('staff-role').value = data.chucVu;

                document.getElementById('staff-username').disabled = true;
                document.getElementById('staff-password').placeholder = "Để trống nếu không muốn đổi mật khẩu";
            } catch (err) {
                alert("Lỗi tải dữ liệu: " + err.message);
            }
        }

        // --- HÀM KHỞI CHẠY CHÍNH (KHI TRANG TẢI XONG) ---
        document.addEventListener('DOMContentLoaded', function () {

            // --- PHẦN 1: CODE ĐIỀU KHIỂN MENU ---
            const menuItems = document.querySelectorAll('.sidebar .menu-item');
            const contentWrappers = document.querySelectorAll('.main-content .content-wrapper');
            const pageTitle = document.getElementById('page-title');
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.querySelector('.toggle-sidebar');
            const mainContent = document.querySelector('.main-content');

            function updateContent(targetId) {
                if (!targetId || targetId === '#') return;
                contentWrappers.forEach(content => content.classList.remove('active'));
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.add('active');
                    const titleEl = targetContent.querySelector('h1') || targetContent.querySelector('h2');
                    if (titleEl) {
                        pageTitle.textContent = titleEl.textContent;
                    } else if (targetId === 'dashboard') {
                        pageTitle.textContent = 'Dashboard';
                    }
                }
            }

            menuItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const targetId = this.getAttribute('data-target');
                    const isSubmenuParent = this.classList.contains('has-submenu');
                    const parentLi = this.closest('.has-submenu');

                    menuItems.forEach(i => i.classList.remove('active'));

                    if (parentLi) {
                        parentLi.classList.add('active');
                    } else if (isSubmenuParent) {
                        this.classList.toggle('active');
                    } else {
                        this.classList.add('active');
                    }

                    if (!parentLi) {
                        document.querySelectorAll('.has-submenu').forEach(otherParent => {
                            if (otherParent !== this) {
                                otherParent.classList.remove('active');
                            }
                        });
                    }

                    updateContent(targetId);

                    if (targetId === 'staffList') {
                        loadDanhSachNhanVien(); // Tải dữ liệu khi bấm tab
                    }
                });
            });

            const initialActiveMenuItem = document.querySelector('.sidebar .menu-item.active');
            if (initialActiveMenuItem) {
                const targetId = initialActiveMenuItem.getAttribute('data-target');
                updateContent(targetId);
                const parent = initialActiveMenuItem.closest('.has-submenu');
                if (parent) {
                    parent.classList.add('active');
                }
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                });
            }

            // --- PHẦN 2: CODE ĐIỀU KHIỂN FORM (THÊM/SỬA) ---
            const staffIdInput = document.getElementById('staff-id');
            const usernameInput = document.getElementById('staff-username');
            const passwordInput = document.getElementById('staff-password');
            const nameInput = document.getElementById('staff-name');
            const emailInput = document.getElementById('staff-email');
            const phoneInput = document.getElementById('staff-phone');
            const dobInput = document.getElementById('staff-dob');
            const cccdInput = document.getElementById('staff-cccd');
            const genderInput = document.getElementById('staff-gender');
            const addressInput = document.getElementById('staff-address');
            const roleInput = document.getElementById('staff-role');

            const btnAdd = document.getElementById('btn-add');
            const btnUpdate = document.getElementById('btn-update');
            const btnDelete = document.getElementById('btn-delete');

            function layDuLieuTuForm() {
                return {
                    id: staffIdInput.value, TenDangNhap: usernameInput.value,
                    MatKhau: passwordInput.value, HoTenNv: nameInput.value,
                    Email: emailInput.value, Sdt: phoneInput.value,
                    NgaySinh: dobInput.value || null, Cccd: cccdInput.value,
                    GioiTinh: genderInput.value, DiaChi: addressInput.value,
                    ChucVu: roleInput.value
                };
            }

            function xoaTrangForm() {
                staffIdInput.value = ""; usernameInput.value = "";
                passwordInput.value = ""; nameInput.value = "";
                emailInput.value = ""; phoneInput.value = "";
                dobInput.value = ""; cccdInput.value = "";
                addressInput.value = "";
                usernameInput.disabled = false;
                passwordInput.placeholder = "Nhập để tạo mới hoặc thay đổi";
            }

            if (btnAdd) {
                btnAdd.addEventListener('click', async () => {
                    const staffData = layDuLieuTuForm();
                    if (staffData.id) {
                        alert("Đang ở chế độ Sửa, không thể Thêm."); return;
                    }
                    if (!staffData.TenDangNhap || !staffData.MatKhau || !staffData.HoTenNv || !staffData.Sdt) {
                        alert("Vui lòng nhập đầy đủ các trường bắt buộc (*)"); return;
                    }
                    try {
                        const response = await fetch('/api/nhanvien', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(staffData)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert('Thêm nhân viên thành công!');
                            xoaTrangForm();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                });
            }

            if (btnUpdate) {
                btnUpdate.addEventListener('click', async () => {
                    const staffData = layDuLieuTuForm();
                    if (!staffData.id) {
                        alert("Không có nhân viên nào được chọn để cập nhật."); return;
                    }
                    const updateModel = {
                        MatKhau: staffData.MatKhau ? staffData.MatKhau : null,
                        HoTenNv: staffData.HoTenNv, Sdt: staffData.Sdt,
                        Email: staffData.Email, DiaChi: staffData.DiaChi,
                        ChucVu: staffData.ChucVu, NgaySinh: staffData.NgaySinh,
                        Cccd: staffData.Cccd, GioiTinh: staffData.GioiTinh
                    };
                    try {
                        const response = await fetch(`/api/nhanvien/${staffData.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateModel)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert('Cập nhật thành công!');
                            passwordInput.value = "";
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                });
            }

            if (btnDelete) {
                btnDelete.addEventListener('click', async () => {
                    const staffId = staffIdInput.value;
                    if (!staffId) {
                        alert("Không có nhân viên nào được chọn để xóa."); return;
                    }
                    if (!confirm(`Bạn có chắc muốn xóa nhân viên ID: ${staffId}?`)) return;
                    try {
                        const response = await fetch(`/api/nhanvien/${staffId}`, { method: 'DELETE' });
                        const result = await response.json();
                        if (response.ok) {
                            alert('Xóa thành công!');
                            xoaTrangForm();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                });
            }

            // --- PHẦN 3: XỬ LÝ SỰ KIỆN CHUNG (CLICK, SEARCH, ...) ---

            function getFilteredData() {
                const searchTerm = document.getElementById('staff-search-input').value.toLowerCase();
                if (!searchTerm) {
                    return allStaffData;
                }
                return allStaffData.filter(nv => {
                    const hoTen = (nv.hoTen || '').toLowerCase();
                    const email = (nv.email || '').toLowerCase();
                    const sdt = (nv.sdt || '').toLowerCase();
                    const chucVu = (nv.chucVu || '').toLowerCase();
                    const cccd = (nv.cccd || '').toLowerCase();
                    const gioiTinh = (nv.gioiTinh || '').toLowerCase();

                    return hoTen.includes(searchTerm) ||
                           email.includes(searchTerm) ||
                           sdt.includes(searchTerm) ||
                           chucVu.includes(searchTerm) ||
                           cccd.includes(searchTerm) ||
                           gioiTinh.includes(searchTerm);
                });
            }

            const searchInput = document.getElementById('staff-search-input');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const filteredData = getFilteredData();
                    renderStaffListAndPagination(filteredData, 1);
                });
            }

            const itemsPerPageSelect = document.getElementById('staff-items-per-page');
            if (itemsPerPageSelect) {
                itemsPerPageSelect.addEventListener('change', function() {
                    itemsPerPage = parseInt(this.value, 10);
                    const filteredData = getFilteredData();
                    renderStaffListAndPagination(filteredData, 1);
                });
            }

            if (mainContent) {
                mainContent.addEventListener('click', async function(e) {

                    if (e.target && e.target.classList.contains('btn-edit')) {
                        e.preventDefault();
                        const staffId = e.target.getAttribute('data-id');
                        if (staffId) {
                            const addEditTab = document.querySelector('.menu-item[data-target="staffAddEdit"]');
                            if (addEditTab) addEditTab.click();
                            loadNhanVienDeSua(staffId);
                        }
                    }

                    if (e.target && e.target.classList.contains('btn-delete-list')) {
                        e.preventDefault();
                        const staffId = e.target.getAttribute('data-id');
                        if (staffId) {
                            if (!confirm(`Bạn có chắc muốn xóa nhân viên ID: ${staffId}?`)) return;
                            try {
                                const response = await fetch(`/api/nhanvien/${staffId}`, { method: 'DELETE' });
                                const result = await response.json();
                                if (response.ok) {
                                    alert('Xóa thành công!');
                                    await loadDanhSachNhanVien();
                                    const filteredData = getFilteredData();
                                    renderStaffListAndPagination(filteredData, 1);
                                } else {
                                    alert('Lỗi: ' + result.message);
                                }
                            } catch (err) {
                                alert('Lỗi kết nối máy chủ: ' + err.message);
                            }
                        }
                    }

                    if (e.target && e.target.closest('.pages') && e.target.tagName === 'BUTTON') {
                        e.preventDefault();
                        const pageNumber = parseInt(e.target.getAttribute('data-page'), 10);
                        if (!isNaN(pageNumber) && pageNumber > 0) {
                            const filteredData = getFilteredData();
                            renderStaffListAndPagination(filteredData, pageNumber);
                        }
                    }
                });
            }
        }); // Hết DOMContentLoaded

        // --- PHẦN 4: TỰ ĐỘNG GỌI HÀM LOAD (KIỂM TRA URL) ---
        (function() {
            const pathParts = window.location.pathname.split('/');
            const lastPart = pathParts[pathParts.length - 1];
            const secondLastPart = pathParts[pathParts.length - 2];

            if (secondLastPart && secondLastPart.toLowerCase() === 'edit' && !isNaN(lastPart)) {
                const staffId = parseInt(lastPart, 10);

                document.addEventListener('DOMContentLoaded', () => {
                    const addEditTab = document.querySelector('.menu-item[data-target="staffAddEdit"]');
                    if (addEditTab) addEditTab.click();
                    loadNhanVienDeSua(staffId);
                });
            }
        })();
    </script>

</body>
</html>