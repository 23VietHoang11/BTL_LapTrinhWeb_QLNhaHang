@{
    ViewData["Title"] = "Dashboard";
}
        <div class="dashboard content-wrapper active" id="dashboard">
            <div class="filters">
                <button>Hôm nay</button>
                <button>Tháng này</button>
                <button>Năm nay</button>
                <button class="active">Tất cả</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-icon">👥</div>
                    <div class="stat-details">
                        <h3>Số lượng tài khoản</h3>
                        <p>16</p>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">📄</div>
                    <div class="stat-details">
                        <h3>Số lượng bài viết</h3>
                        <p>4</p>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">🍴</div>
                    <div class="stat-details">
                        <h3>Số lượng món ăn</h3>
                        <p>10</p>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">🧾</div>
                    <div class="stat-details">
                        <h3>Số lượng danh mục</h3>
                        <p>7</p>
                    </div>
                </div>
            </div>
            <div class="chart-section">
                <h3>Thống Kê Hóa Đơn</h3>
                <div class="chart-filters">
                    <select>
                        <option>Cả năm</option>
                        <option>Tháng 1</option>
                        <option>Tháng 2</option>
                    </select>
                </div>
                <div class="chart-container">
                    <p>Biểu đồ sẽ hiển thị ở đây</p>
                </div>
                <div class="chart-legend">
                    <div><span class="legend-color" style="background-color: #6c5ce7;"></span> Hủy đơn</div>
                    <div><span class="legend-color" style="background-color: #00b894;"></span> Chờ thanh toán cọc</div>
                    <div><span class="legend-color" style="background-color: #fdcb6e;"></span> Hết hạn thanh toán cọc</div>
                    <div><span class="legend-color" style="background-color: #e84393;"></span> Đã thanh toán cọc</div>
                    <div><span class="legend-color" style="background-color: #0984e3;"></span> Chờ thanh toán toàn bộ đơn</div>
                    <div><span class="legend-color" style="background-color: #f1c40f;"></span> Hoàn thành đơn</div>
                </div>
            </div>
        </div>

<script>
    // --- BIẾN TOÀN CỤC ---
    let allStaffData = [];
    let currentPage = 1;
    let itemsPerPage = 5;
    let allMonAnData = [];
    let currentMonAnPage = 1;
    let itemsPerMonAnPage = 5;
    let allNguyenLieuData = [];
    let currentNguyenLieuPage = 1;
    let itemsPerNguyenLieuPage = 5;

    // --- HÀM HELPER (TẢI HÓA ĐƠN) ---
    function formatDuration(ms) {
        if (ms < 0) ms = 0;
        const seconds = Math.floor((ms / 1000) % 60);
        const minutes = Math.floor((ms / (1000 * 60)) % 60);
        const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
        const hh = hours.toString().padStart(2, '0');
        const mm = minutes.toString().padStart(2, '0');
        const ss = seconds.toString().padStart(2, '0');
        return `${hh}:${mm}:${ss}`;
    }
    async function loadCurrentInvoices() {
        const container = document.querySelector('#invoiceContent .invoice-list');
        if (!container) return;
        container.innerHTML = '<p>Đang tải đơn hàng...</p>';
        try {
            const response = await fetch('/api/hoadon/current');
            if (!response.ok) {
                container.innerHTML = '<p>Lỗi: Không thể tải hóa đơn.</p>'; return;
            }
            const invoices = await response.json();
            if (invoices.length === 0) {
                container.innerHTML = '<p>Không có đơn hàng nào hiện tại.</p>'; return;
            }
            container.innerHTML = '';
            invoices.forEach(hd => {
                let thoiGianGiaoFormatted = '';
                if (hd.thoiGianGiao) {
                    try {
                        thoiGianGiaoFormatted = new Date(hd.thoiGianGiao).toLocaleString('vi-VN', {
                            hour: '2-digit', minute: '2-digit',
                            day: '2-digit', month: '2-digit', year: 'numeric'
                        });
                    } catch (e) { thoiGianGiaoFormatted = 'Lỗi ngày'; }
                }
                const card = `
                    <div class="invoice-card">
                        <h3>${hd.hoTenKhachHang || 'Khách vãng lai'}</h3>
                        <div class="invoice-details">
                            <div class="table-number"><p>SĐT</p><p>${hd.sdtKhachHang || 'N/A'}</p></div>
                            <div class="guest-count"><p>👥 ${hd.soLuongKhach || 0}</p></div>
                            <div class="timer"><p>⏰ ${thoiGianGiaoFormatted}</p></div>
                            <div class="total-amount"><p>💰 ${hd.tongTien ? hd.tongTien.toLocaleString('vi-VN') : 0} đ</p></div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn-edit-invoice" data-id="${hd.idHoaDon}">Sửa</button>
                            <button class="pay-btn" data-id="${hd.idHoaDon}">Thanh toán</button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        } catch (err) {
            container.innerHTML = '<p>Lỗi kết nối máy chủ. Không thể tải đơn.</p>';
            console.error(err);
        }
    }
    async function loadInvoiceCreateForm() {
        // Dọn dẹp form (logic nhập tay)
        document.getElementById('invoice-id').value = '';
        document.getElementById('invoice-customer-phone').value = '';
        document.getElementById('invoice-customer-name').value = '';
        document.getElementById('invoice-time-input').value = '';
        document.getElementById('invoice-guest-count').value = '1';
        document.getElementById('invoice-total-amount').value = '0';
        document.getElementById('invoice-notes').value = '';

        document.getElementById('btn-save-invoice').style.display = 'inline-block';
        document.getElementById('btn-update-invoice').style.display = 'none';
        document.getElementById('btn-delete-invoice').style.display = 'none';
    }
    async function loadHoaDonDeSua(id) {
        try {
            const response = await fetch(`/api/hoadon/${id}`);
            if (!response.ok) {
                alert("Không thể tải thông tin hóa đơn."); return;
            }
            const data = await response.json();
            document.getElementById('invoice-id').value = data.idhoaDon;
            document.getElementById('invoice-customer-phone').value = data.sdtKhachHang;
            document.getElementById('invoice-customer-name').value = data.hoTenKhachHang;
            document.getElementById('invoice-time-input').value = data.thoiGianGiao ? new Date(data.thoiGianGiao).toISOString().slice(0, 16) : "";
            document.getElementById('invoice-guest-count').value = data.soLuongKhach;
            document.getElementById('invoice-total-amount').value = data.tongTien;
            document.getElementById('invoice-notes').value = data.ghiChu;

            document.getElementById('btn-save-invoice').style.display = 'none';
            document.getElementById('btn-update-invoice').style.display = 'inline-block';
            document.getElementById('btn-delete-invoice').style.display = 'inline-block';
        } catch (err) {
            alert("Lỗi tải dữ liệu: " + err.message);
        }
    }

            // --- ▼▼▼ THÊM HÀM MỚI (LIÊN HỆ/BÀI VIẾT) ▼▼▼ ---
    function renderLienHeList(dataToRender) {
        const tableBody = document.querySelector('#postContent table tbody');
        if (!tableBody) return;

        tableBody.innerHTML = ''; // Xóa nội dung cũ

        if (dataToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Không có tin nhắn nào.</td></tr>';
            return;
        }

        dataToRender.forEach(msg => {
            const ngayGuiFormatted = new Date(msg.ngayGui).toLocaleString('vi-VN');
            const row = `
                <tr style="${msg.daDoc ? '' : 'font-weight: bold;'}">
                    <td>${ngayGuiFormatted}</td>
                    <td>${msg.hoTen}</td>
                    <td>${msg.email}</td>
                    <td>${msg.tieuDe || ''}</td>
                    <td>${msg.noiDung}</td>
                    <td>${msg.daDoc ? 'Đã đọc' : 'Mới'}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    async function loadLienHeList() {
        try {
            const response = await fetch('/api/lienhe');
            if (!response.ok) {
                alert("Không thể tải danh sách tin nhắn."); return;
            }
            const allLienHeData = await response.json();

            // Lọc và vẽ
            const searchTerm = document.getElementById('lienhe-search-input').value.toLowerCase();
            const filteredData = allLienHeData.filter(msg => {
                return (msg.hoTen || '').toLowerCase().includes(searchTerm) ||
                       (msg.email || '').toLowerCase().includes(searchTerm) ||
                       (msg.tieuDe || '').toLowerCase().includes(searchTerm) ||
                       (msg.noiDung || '').toLowerCase().includes(searchTerm);
            });

            renderLienHeList(filteredData);

        } catch (err) {
            alert("Lỗi tải danh sách tin nhắn: " + err.message);
        }
    }

    // --- HÀM HELPER (NHÂN VIÊN) ---
    function renderStaffListAndPagination(dataToRender, page) {
        currentPage = page;
        const tableBody = document.querySelector('#staffList table tbody');
        const paginationContainer = document.querySelector('#staffList .pages');
        if (!tableBody || !paginationContainer) return;

        tableBody.innerHTML = '';
        paginationContainer.innerHTML = '';

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = dataToRender.slice(start, end);

        paginatedItems.forEach(nv => {
            let ngaySinhFormatted = '';
            if (nv.ngaySinh) {
                try {
                    ngaySinhFormatted = new Date(nv.ngaySinh).toLocaleDateString('vi-VN');
                } catch (e) { ngaySinhFormatted = nv.ngaySinh; }
            }
            const row = `
                <tr>
                    <td>${nv.hoTen}</td>
                    <td>${nv.email || ''}</td>
                    <td>${nv.sdt || ''}</td>
                    <td><span class="badge role-type">${nv.chucVu || ''}</span></td>
                    <td>${ngaySinhFormatted}</td>
                    <td>${nv.cccd || ''}</td>
                    <td>${nv.gioiTinh || ''}</td>
                    <td class="actions">
                        <button class="btn-edit" data-id="${nv.id}">Sửa</button>
                        <button class="btn-delete-list" data-id="${nv.id}">Xóa</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        const pageCount = Math.ceil(dataToRender.length / itemsPerPage);
        paginationContainer.innerHTML += `<button data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;
        for (let i = 1; i <= pageCount; i++) {
            paginationContainer.innerHTML += `<button data-page="${i}" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
        paginationContainer.innerHTML += `<button data-page="${currentPage + 1}" ${currentPage === pageCount ? 'disabled' : ''}>&gt;</button>`;
    }
    async function loadDanhSachNhanVien() {
        try {
            const response = await fetch('/api/nhanvien');
            if (!response.ok) {
                alert("Không thể tải danh sách nhân viên."); return;
            }
            allStaffData = await response.json();
            const selectElement = document.getElementById('staff-items-per-page');
            if (selectElement) itemsPerPage = parseInt(selectElement.value, 10);
            renderStaffListAndPagination(allStaffData, 1);
        } catch (err) {
            alert("Lỗi tải danh sách: " + err.message);
            allStaffData = [];
        }
    }
    async function loadNhanVienDeSua(id) {
        try {
            const response = await fetch(`/api/nhanvien/${id}`);
            if (!response.ok) {
                alert("Không thể tải thông tin nhân viên."); return;
            }
            const data = await response.json();
            document.getElementById('staff-id').value = data.idnhanVien;
            document.getElementById('staff-username').value = data.tenDangNhap;
            document.getElementById('staff-name').value = data.hoTenNv;
            document.getElementById('staff-email').value = data.email;
            document.getElementById('staff-phone').value = data.sdt;
            document.getElementById('staff-dob').value = data.ngaySinh ? data.ngaySinh.split('T')[0] : "";
            document.getElementById('staff-cccd').value = data.cccd;
            document.getElementById('staff-gender').value = data.gioiTinh;
            document.getElementById('staff-address').value = data.diaChi;
            document.getElementById('staff-role').value = data.chucVu;
            document.getElementById('staff-username').disabled = true;
            document.getElementById('staff-password').placeholder = "Để trống nếu không muốn đổi mật khẩu";
        } catch (err) {
            alert("Lỗi tải dữ liệu: " + err.message);
        }
    }

    // --- HÀM HELPER (MÓN ĂN) ---
    function renderMonAnListAndPagination(dataToRender, page) {
        currentMonAnPage = page;
        const tableBody = document.querySelector('#menuList table tbody');
        const paginationContainer = document.querySelector('#monan-pagination');
        if (!tableBody || !paginationContainer) return;

        tableBody.innerHTML = '';
        paginationContainer.innerHTML = '';

        const start = (currentMonAnPage - 1) * itemsPerMonAnPage;
        const end = start + itemsPerMonAnPage;
        const paginatedItems = dataToRender.slice(start, end);

        paginatedItems.forEach(ma => {
            const row = `
                <tr>
                    <td><img src="${ma.hinhAnh || 'https://via.placeholder.com/50'}" alt="${ma.tenMon}" style="width:50px; height:50px; object-fit:cover;"></td>
                    <td>${ma.tenMon}</td>
                    <td>${ma.loai || ''}</td>
                    <td>${ma.donViTinh || ''}</td>
                    <td>${ma.gia ? ma.gia.toLocaleString('vi-VN') : 0} đ</td>
                    <td class="actions">
                        <button class="btn-edit-monan" data-id="${ma.idmonAn}">Sửa</button>
                        <button class="btn-delete-monan-list" data-id="${ma.idmonAn}">Xóa</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        const pageCount = Math.ceil(dataToRender.length / itemsPerMonAnPage);
        paginationContainer.innerHTML += `<button data-page="${currentMonAnPage - 1}" ${currentMonAnPage === 1 ? 'disabled' : ''}>&lt;</button>`;
        for (let i = 1; i <= pageCount; i++) {
            paginationContainer.innerHTML += `<button data-page="${i}" class="${i === currentMonAnPage ? 'active' : ''}">${i}</button>`;
        }
        paginationContainer.innerHTML += `<button data-page="${currentMonAnPage + 1}" ${currentMonAnPage === pageCount ? 'disabled' : ''}>&gt;</button>`;
    }
    async function loadMonAnList() {
        try {
            const response = await fetch('/api/monan');
            if (!response.ok) {
                alert("Không thể tải danh sách món ăn."); return;
            }
            allMonAnData = await response.json();
            const selectElement = document.getElementById('monan-items-per-page');
            if (selectElement) itemsPerMonAnPage = parseInt(selectElement.value, 10);
            renderMonAnListAndPagination(allMonAnData, 1);
        } catch (err) {
            alert("Lỗi tải danh sách món ăn: " + err.message);
            allMonAnData = [];
        }
    }
    function loadMonAnCreateForm() {
        document.getElementById('monan-id').value = '';
        document.getElementById('monan-name').value = '';
        document.getElementById('monan-type').value = 'Đồ uống';
        document.getElementById('monan-unit').value = '';
        document.getElementById('monan-price').value = '0';
        document.getElementById('monan-image').value = '';

        document.getElementById('btn-save-monan').style.display = 'inline-block';
        document.getElementById('btn-update-monan').style.display = 'none';
        document.getElementById('btn-delete-monan').style.display = 'none';
    }
    async function loadMonAnDeSua(id) {
        try {
            const response = await fetch(`/api/monan/${id}`);
            if (!response.ok) {
                alert("Không thể tải thông tin món ăn."); return;
            }
            const data = await response.json();

            document.getElementById('monan-id').value = data.idmonAn;
            document.getElementById('monan-name').value = data.tenMon;
            document.getElementById('monan-type').value = data.loai;
            document.getElementById('monan-unit').value = data.donViTinh;
            document.getElementById('monan-price').value = data.gia;
            document.getElementById('monan-image').value = data.hinhAnh;

            document.getElementById('btn-save-monan').style.display = 'none';
            document.getElementById('btn-update-monan').style.display = 'inline-block';
            document.getElementById('btn-delete-monan').style.display = 'inline-block';
        } catch (err) {
            alert("Lỗi tải dữ liệu món ăn: " + err.message);
        }
    }

    // --- HÀM HELPER (NGUYÊN LIỆU) ---
    function renderNguyenLieuListAndPagination(dataToRender, page) {
        currentNguyenLieuPage = page;
        const tableBody = document.querySelector('#nguyenLieuList table tbody');
        const paginationContainer = document.querySelector('#nguyenlieu-pagination');
        if (!tableBody || !paginationContainer) return;

        tableBody.innerHTML = '';
        paginationContainer.innerHTML = '';

        const start = (currentNguyenLieuPage - 1) * itemsPerNguyenLieuPage;
        const end = start + itemsPerNguyenLieuPage;
        const paginatedItems = dataToRender.slice(start, end);

        paginatedItems.forEach(nl => {
            let ngayNhapFormatted = '';
            if (nl.ngayNhap) {
                try {
                    ngayNhapFormatted = new Date(nl.ngayNhap).toLocaleDateString('vi-VN');
                } catch (e) { }
            }

            const row = `
                <tr>
                    <td><img src="${nl.hinhAnh || 'https://via.placeholder.com/50'}" alt="${nl.tenNl}" style="width:50px; height:50px; object-fit:cover;"></td>
                    <td>${nl.tenNl}</td>
                    <td>${nl.donVi || ''}</td>
                    <td>${nl.loai || ''}</td>
                    <td>${nl.soLuong || 0}</td>
                    <td>${ngayNhapFormatted}</td>
                    <td class="actions">
                        <button class="btn-edit-nguyenlieu" data-id="${nl.idnguyenLieu}">Sửa</button>
                        <button class="btn-delete-nguyenlieu-list" data-id="${nl.idnguyenLieu}">Xóa</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        const pageCount = Math.ceil(dataToRender.length / itemsPerNguyenLieuPage);
        paginationContainer.innerHTML += `<button data-page="${currentNguyenLieuPage - 1}" ${currentNguyenLieuPage === 1 ? 'disabled' : ''}>&lt;</button>`;
        for (let i = 1; i <= pageCount; i++) {
            paginationContainer.innerHTML += `<button data-page="${i}" class="${i === currentNguyenLieuPage ? 'active' : ''}">${i}</button>`;
        }
        paginationContainer.innerHTML += `<button data-page="${currentNguyenLieuPage + 1}" ${currentNguyenLieuPage === pageCount ? 'disabled' : ''}>&gt;</button>`;
    }

    async function loadNguyenLieuList() {
        try {
            const response = await fetch('/api/nguyenlieu');
            if (!response.ok) {
                alert("Không thể tải danh sách nguyên liệu."); return;
            }
            allNguyenLieuData = await response.json();
            const selectElement = document.getElementById('nguyenlieu-items-per-page');
            if (selectElement) itemsPerNguyenLieuPage = parseInt(selectElement.value, 10);
            renderNguyenLieuListAndPagination(allNguyenLieuData, 1);
        } catch (err) {
            alert("Lỗi tải danh sách nguyên liệu: " + err.message);
            allNguyenLieuData = [];
        }
    }

    function loadNguyenLieuCreateForm() {
        document.getElementById('nguyenlieu-id').value = '';
        document.getElementById('nguyenlieu-name').value = '';
        document.getElementById('nguyenlieu-unit').value = '';
        document.getElementById('nguyenlieu-type').value = '';
        document.getElementById('nguyenlieu-quantity').value = '0';
        document.getElementById('nguyenlieu-date').value = '';
        document.getElementById('nguyenlieu-image').value = '';

        document.getElementById('btn-save-nguyenlieu').style.display = 'inline-block';
        document.getElementById('btn-update-nguyenlieu').style.display = 'none';
        document.getElementById('btn-delete-nguyenlieu').style.display = 'none';
    }

    async function loadNguyenLieuDeSua(id) {
        try {
            const response = await fetch(`/api/nguyenlieu/${id}`);
            if (!response.ok) {
                alert("Không thể tải thông tin nguyên liệu."); return;
            }
            const data = await response.json();

            document.getElementById('nguyenlieu-id').value = data.idnguyenLieu;
            document.getElementById('nguyenlieu-name').value = data.tenNl;
            document.getElementById('nguyenlieu-unit').value = data.donVi;
            document.getElementById('nguyenlieu-type').value = data.loai;
            document.getElementById('nguyenlieu-quantity').value = data.soLuong;
            document.getElementById('nguyenlieu-date').value = data.ngayNhap ? new Date(data.ngayNhap).toISOString().split('T')[0] : "";
            document.getElementById('nguyenlieu-image').value = data.hinhAnh;

            document.getElementById('btn-save-nguyenlieu').style.display = 'none';
            document.getElementById('btn-update-nguyenlieu').style.display = 'inline-block';
            document.getElementById('btn-delete-nguyenlieu').style.display = 'inline-block';
        } catch (err) {
            alert("Lỗi tải dữ liệu nguyên liệu: " + err.message);
        }
    }

    // --- HÀM KHỞI CHẠY CHÍNH (KHI TRANG TẢI XONG) ---
    document.addEventListener('DOMContentLoaded', function () {

        // --- PHẦN 1: CODE ĐIỀU KHIỂN MENU ---
        const menuItems = document.querySelectorAll('.sidebar .menu-item');
        const contentWrappers = document.querySelectorAll('.main-content .content-wrapper');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.querySelector('.toggle-sidebar');
        const mainContent = document.querySelector('.main-content');

        function updateContent(targetId) {
            // Sửa: Bỏ qua tất cả các menu cha
            if (!targetId || targetId === '#' || targetId === 'invoiceParent' || targetId === 'staffContent' || targetId === 'roleContent' || targetId === 'otherContent' || targetId === 'menuContent' || targetId === 'khoContent') return;
            contentWrappers.forEach(content => content.classList.remove('active'));

            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.add('active');
                const titleEl = targetContent.querySelector('h1') || targetContent.querySelector('h2');
                if (titleEl) {
                    pageTitle.textContent = titleEl.textContent;
                } else if (targetId === 'dashboard') {
                    pageTitle.textContent = 'Dashboard';
                }
            }
        }

        menuItems.forEach(item => {
            item.addEventListener('click', function (e) {
                e.stopPropagation();
                const targetId = this.getAttribute('data-target');
                const isSubmenuParent = this.classList.contains('has-submenu');
                const parentLi = this.closest('.has-submenu');

                menuItems.forEach(i => i.classList.remove('active'));

                if (parentLi) {
                    parentLi.classList.add('active');
                } else if (isSubmenuParent) {
                    this.classList.toggle('active');
                } else {
                    this.classList.add('active');
                }

                if (!parentLi) {
                    document.querySelectorAll('.has-submenu').forEach(otherParent => {
                        if (otherParent !== this && otherParent.getAttribute('data-target') !== this.getAttribute('data-target')) {
                            otherParent.classList.remove('active');
                        }
                    });
                }

                updateContent(targetId);

                // GỌI HÀM TẢI DỮ LIỆU TƯƠNG ỨNG
                if (targetId === 'staffList') {
                    loadDanhSachNhanVien();
                } else if (targetId === 'invoiceContent') {
                    loadCurrentInvoices();
                } else if (targetId === 'invoiceAddEdit') {
                    loadInvoiceCreateForm();
                } else if (targetId === 'staffAddEdit') {
                    xoaTrangForm();
                }
                else if (targetId === 'menuList') {
                    loadMonAnList();
                } else if (targetId === 'menuAddEdit') {
                    loadMonAnCreateForm();
                }
                else if (targetId === 'nguyenLieuList') {
                    loadNguyenLieuList();
                } else if (targetId === 'nguyenLieuAddEdit') {
                    loadNguyenLieuCreateForm();
                }
                else if (targetId === 'postContent') {
                loadLienHeList();
            }
            });
        });

       const initialActiveMenuItem = document.querySelector('.sidebar .menu-item.active');
        if (initialActiveMenuItem) {
            const targetId = initialActiveMenuItem.getAttribute('data-target');
            updateContent(targetId);
            if (targetId === 'staffList') loadDanhSachNhanVien();
            else if (targetId === 'invoiceContent') loadCurrentInvoices();
            else if (targetId === 'menuList') loadMonAnList();
            else if (targetId === 'nguyenLieuList') loadNguyenLieuList();
            else if (targetId === 'postContent') loadLienHeList();
            const parent = initialActiveMenuItem.closest('.has-submenu');
            if (parent) parent.classList.add('active');
        }
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function () {
                sidebar.classList.toggle('collapsed');
            });
        }

        // --- PHẦN 2: CODE ĐIỀU KHIỂN FORM NHÂN VIÊN (staffAddEdit) ---
        const staffIdInput = document.getElementById('staff-id');
        const usernameInput = document.getElementById('staff-username');
        const passwordInput = document.getElementById('staff-password');
        const nameInput = document.getElementById('staff-name');
        const emailInput = document.getElementById('staff-email');
        const phoneInput = document.getElementById('staff-phone');
        const dobInput = document.getElementById('staff-dob');
        const cccdInput = document.getElementById('staff-cccd');
        const genderInput = document.getElementById('staff-gender');
        const addressInput = document.getElementById('staff-address');
        const roleInput = document.getElementById('staff-role');

        const btnAdd = document.getElementById('btn-add');
        const btnUpdate = document.getElementById('btn-update');
        const btnDelete = document.getElementById('btn-delete');

        function layDuLieuTuForm() {
            return {
                id: staffIdInput.value, TenDangNhap: usernameInput.value,
                MatKhau: passwordInput.value, HoTenNv: nameInput.value,
                Email: emailInput.value, Sdt: phoneInput.value,
                NgaySinh: dobInput.value || null, Cccd: cccdInput.value,
                GioiTinh: genderInput.value, DiaChi: addressInput.value,
                ChucVu: roleInput.value
            };
        }
        function xoaTrangForm() {
            if (staffIdInput) staffIdInput.value = "";
            if (usernameInput) usernameInput.value = "";
            if (passwordInput) passwordInput.value = "";
            if (nameInput) nameInput.value = "";
            if (emailInput) emailInput.value = "";
            if (phoneInput) phoneInput.value = "";
            if (dobInput) dobInput.value = "";
            if (cccdInput) cccdInput.value = "";
            if (addressInput) addressInput.value = "";
            if (usernameInput) usernameInput.disabled = false;
            if (passwordInput) passwordInput.placeholder = "Nhập để tạo mới hoặc thay đổi";
        }
        if (btnAdd) {
            btnAdd.addEventListener('click', async () => {
                const staffData = layDuLieuTuForm();
                if (staffData.id) {
                    alert("Đang ở chế độ Sửa, không thể Thêm."); return;
                }
                if (!staffData.TenDangNhap || !staffData.MatKhau || !staffData.HoTenNv || !staffData.Sdt) {
                    alert("Vui lòng nhập đầy đủ các trường bắt buộc (*)"); return;
                }
                try {
                    const response = await fetch('/api/nhanvien', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(staffData)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Thêm nhân viên thành công!');
                        xoaTrangForm();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (err) {
                    alert('Lỗi kết nối máy chủ: ' + err.message);
                }
            });
        }
        if (btnUpdate) {
            btnUpdate.addEventListener('click', async () => {
                const staffData = layDuLieuTuForm();
                if (!staffData.id) {
                    alert("Không có nhân viên nào được chọn để cập nhật."); return;
                }
                const updateModel = {
                    MatKhau: staffData.MatKhau ? staffData.MatKhau : null,
                    HoTenNv: staffData.HoTenNv, Sdt: staffData.Sdt,
                    Email: staffData.Email, DiaChi: staffData.DiaChi,
                    ChucVu: staffData.ChucVu, NgaySinh: staffData.NgaySinh,
                    Cccd: staffData.Cccd, GioiTinh: staffData.GioiTinh
                };
                try {
                    const response = await fetch(`/api/nhanvien/${staffData.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateModel)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Cập nhật thành công!');
                        passwordInput.value = "";
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (err) {
                    alert('Lỗi kết nối máy chủ: ' + err.message);
                }
            });
        }
        if (btnDelete) {
            btnDelete.addEventListener('click', async () => {
                const staffId = staffIdInput.value;
                if (!staffId) {
                    alert("Không có nhân viên nào được chọn để xóa."); return;
                }
                if (!confirm(`Bạn có chắc muốn xóa nhân viên ID: ${staffId}?`)) return;
                try {
                    const response = await fetch(`/api/nhanvien/${staffId}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Xóa thành công!');
                        xoaTrangForm();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                } catch (err) {
                    alert('Lỗi kết nối máy chủ: ' + err.message);
                }
            });
        }

        // --- PHẦN 3: XỬ LÝ SỰ KIỆN CHUNG (SEARCH, PAGINATION) ---

        // Tìm kiếm/Phân trang NHÂN VIÊN
        function getFilteredData() {
            const searchTerm = document.getElementById('staff-search-input').value.toLowerCase();
            if (!searchTerm) {
                return allStaffData;
            }
            return allStaffData.filter(nv => {
                const hoTen = (nv.hoTen || '').toLowerCase();
                const email = (nv.email || '').toLowerCase();
                const sdt = (nv.sdt || '').toLowerCase();
                const chucVu = (nv.chucVu || '').toLowerCase();
                const cccd = (nv.cccd || '').toLowerCase();
                const gioiTinh = (nv.gioiTinh || '').toLowerCase();
                return hoTen.includes(searchTerm) || email.includes(searchTerm) || sdt.includes(searchTerm) ||
                       chucVu.includes(searchTerm) || cccd.includes(searchTerm) || gioiTinh.includes(searchTerm);
            });
        }
        const searchInput = document.getElementById('staff-search-input');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const filteredData = getFilteredData();
                renderStaffListAndPagination(filteredData, 1);
            });
        }
        const itemsPerPageSelect = document.getElementById('staff-items-per-page');
        if (itemsPerPageSelect) {
            itemsPerPageSelect.addEventListener('change', function() {
                itemsPerPage = parseInt(this.value, 10);
                const filteredData = getFilteredData();
                renderStaffListAndPagination(filteredData, 1);
            });
        }
        const lienheSearchInput = document.getElementById('lienhe-search-input');
    if (lienheSearchInput) {
        lienheSearchInput.addEventListener('keyup', function() {
            loadLienHeList(); // Gọi lại hàm load (đã bao gồm lọc)
        });
    }

        // Tìm kiếm/Phân trang MÓN ĂN
        function getFilteredMonAnData() {
            const searchTerm = document.getElementById('monan-search-input').value.toLowerCase();
            if (!searchTerm) {
                return allMonAnData;
            }
            return allMonAnData.filter(ma => {
                const ten = (ma.tenMon || '').toLowerCase();
                const loai = (ma.loai || '').toLowerCase();
                return ten.includes(searchTerm) || loai.includes(searchTerm);
            });
        }
        const monanSearchInput = document.getElementById('monan-search-input');
        if (monanSearchInput) {
            monanSearchInput.addEventListener('keyup', function() {
                const filteredData = getFilteredMonAnData();
                renderMonAnListAndPagination(filteredData, 1);
            });
        }
        const monanItemsPerPageSelect = document.getElementById('monan-items-per-page');
        if (monanItemsPerPageSelect) {
            monanItemsPerPageSelect.addEventListener('change', function() {
                itemsPerMonAnPage = parseInt(this.value, 10);
                const filteredData = getFilteredMonAnData();
                renderMonAnListAndPagination(filteredData, 1);
            });
        }

        // Tìm kiếm/Phân trang NGUYÊN LIỆU
        // ▼▼▼ SỬA CODE TÌM KIẾM/PHÂN TRANG NGUYÊN LIỆU ▼▼▼
        function getFilteredNguyenLieuData() {
            const searchTerm = document.getElementById('nguyenlieu-search-input').value.toLowerCase();
            if (!searchTerm) {
                return allNguyenLieuData;
            }
            return allNguyenLieuData.filter(nl => {
                const ten = (nl.tenNl || '').toLowerCase();
                const loai = (nl.loai || '').toLowerCase();
                return ten.includes(searchTerm) || loai.includes(searchTerm);
            });
        }
        const nguyenlieuSearchInput = document.getElementById('nguyenlieu-search-input');
        if (nguyenlieuSearchInput) {
            nguyenlieuSearchInput.addEventListener('keyup', function() {
                const filteredData = getFilteredNguyenLieuData();
                renderNguyenLieuListAndPagination(filteredData, 1);
            });
        }
        const nguyenlieuItemsPerPageSelect = document.getElementById('nguyenlieu-items-per-page');
        if (nguyenlieuItemsPerPageSelect) {
            nguyenlieuItemsPerPageSelect.addEventListener('change', function() {
                itemsPerNguyenLieuPage = parseInt(this.value, 10);
                const filteredData = getFilteredNguyenLieuData();
                renderNguyenLieuListAndPagination(filteredData, 1);
            });
        }

        // --- PHẦN 4: SỰ KIỆN CLICK CHUNG (DELEGATION) ---
        if (mainContent) {
            mainContent.addEventListener('click', async function(e) {

                // --- Sự kiện cho TÀI KHOẢN ---
                if (e.target && e.target.classList.contains('btn-edit')) {
                    e.preventDefault();
                    const staffId = e.target.getAttribute('data-id');
                    if (staffId) {
                        document.querySelector('.menu-item[data-target="staffAddEdit"]').click();
                        loadNhanVienDeSua(staffId);
                    }
                }
                if (e.target && e.target.classList.contains('btn-delete-list')) {
                    e.preventDefault();
                    const staffId = e.target.getAttribute('data-id');
                    if (staffId) {
                        if (!confirm(`Bạn có chắc muốn xóa nhân viên ID: ${staffId}?`)) return;
                        try {
                            const response = await fetch(`/api/nhanvien/${staffId}`, { method: 'DELETE' });
                            const result = await response.json();
                            if (response.ok) {
                                alert('Xóa thành công!');
                                await loadDanhSachNhanVien();
                                const filteredData = getFilteredData();
                                renderStaffListAndPagination(filteredData, 1);
                            } else {
                                alert('Lỗi: ' + result.message);
                            }
                        } catch (err) {
                            alert('Lỗi kết nối máy chủ: ' + err.message);
                        }
                    }
                }
                if (e.target && e.target.closest('#staffList .pages') && e.target.tagName === 'BUTTON') {
                    e.preventDefault();
                    const pageNumber = parseInt(e.target.getAttribute('data-page'), 10);
                    if (!isNaN(pageNumber) && pageNumber > 0) {
                        const filteredData = getFilteredData();
                        renderStaffListAndPagination(filteredData, pageNumber);
                    }
                }

                // --- Sự kiện cho HÓA ĐƠN ---
                if (e.target && e.target.classList.contains('pay-btn')) {
                    e.preventDefault();
                    const hoaDonId = e.target.getAttribute('data-id');
                    alert('Bạn đã bấm thanh toán cho Hóa đơn ID: ' + hoaDonId);
                }
                if (e.target && e.target.classList.contains('btn-edit-invoice')) {
                    e.preventDefault();
                    const hoaDonId = e.target.getAttribute('data-id');
                    if (hoaDonId) {
                        document.querySelector('.menu-item[data-target="invoiceAddEdit"]').click();
                        loadHoaDonDeSua(hoaDonId);
                    }
                }
                function getInvoiceFormData() {
                    return {
                        SdtKhachHang: document.getElementById('invoice-customer-phone').value,
                        HoTenKhachHang: document.getElementById('invoice-customer-name').value,
                        ThoiGian: document.getElementById('invoice-time-input').value,
                        SoLuongKhach: parseInt(document.getElementById('invoice-guest-count').value, 10),
                        TongTien: parseFloat(document.getElementById('invoice-total-amount').value) || 0,
                        GhiChu: document.getElementById('invoice-notes').value
                    };
                }
                if (e.target && e.target.id === 'btn-save-invoice') {
                    e.preventDefault();
                    const data = getInvoiceFormData();
                    if (!data.SdtKhachHang || !data.HoTenKhachHang || !data.ThoiGian) {
                        alert('Vui lòng nhập SĐT, Tên khách hàng và Thời gian!'); return;
                    }
                    try {
                        const response = await fetch('/api/hoadon', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="invoiceContent"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-update-invoice') {
                    e.preventDefault();
                    const invoiceId = document.getElementById('invoice-id').value;
                    if (!invoiceId) {
                        alert("Lỗi: Không tìm thấy ID Hóa đơn để cập nhật."); return;
                    }
                    const data = getInvoiceFormData();
                    if (!data.SdtKhachHang || !data.HoTenKhachHang || !data.ThoiGian) {
                        alert('Vui lòng nhập SĐT, Tên khách hàng và Thời gian!'); return;
                    }
                    try {
                        const response = await fetch(`/api/hoadon/${invoiceId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="invoiceContent"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-delete-invoice') {
                    e.preventDefault();
                    const invoiceId = document.getElementById('invoice-id').value;
                    if (!invoiceId) {
                        alert("Lỗi: Không tìm thấy ID Hóa đơn để xóa."); return;
                    }
                    if (!confirm(`Bạn có chắc muốn xóa vĩnh viễn hóa đơn ID: ${invoiceId}?`)) return;
                    try {
                        const response = await fetch(`/api/hoadon/${invoiceId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="invoiceContent"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-cancel-invoice') {
                    e.preventDefault();
                    document.querySelector('.menu-item[data-target="invoiceContent"]').click();
                }

                // --- Sự kiện cho MÓN ĂN ---
                function getMonAnFormData() {
                    return {
                        TenMon: document.getElementById('monan-name').value,
                        Loai: document.getElementById('monan-type').value,
                        DonViTinh: document.getElementById('monan-unit').value,
                        Gia: parseFloat(document.getElementById('monan-price').value) || 0,
                        HinhAnh: document.getElementById('monan-image').value
                    };
                }
                if (e.target && e.target.id === 'btn-save-monan') {
                    e.preventDefault();
                    const data = getMonAnFormData();
                    if (!data.TenMon || !data.Loai || !data.DonViTinh) {
                        alert('Vui lòng nhập Tên, Loại và Đơn vị tính!'); return;
                    }
                    try {
                        const response = await fetch('/api/monan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="menuList"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-update-monan') {
                    e.preventDefault();
                    const monAnId = document.getElementById('monan-id').value;
                    if (!monAnId) {
                        alert("Lỗi: Không tìm thấy ID Món ăn để cập nhật."); return;
                    }
                    const data = getMonAnFormData();
                    if (!data.TenMon || !data.Loai || !data.DonViTinh) {
                        alert('Vui lòng nhập Tên, Loại và Đơn vị tính!'); return;
                    }
                    try {
                        const response = await fetch(`/api/monan/${monAnId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="menuList"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-delete-monan') {
                    e.preventDefault();
                    const monAnId = document.getElementById('monan-id').value;
                    if (!monAnId) {
                        alert("Lỗi: Không tìm thấy ID Món ăn để xóa."); return;
                    }
                    if (!confirm(`Bạn có chắc muốn xóa vĩnh viễn món ăn ID: ${monAnId}?`)) return;

                    try {
                        const response = await fetch(`/api/monan/${monAnId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="menuList"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.classList.contains('btn-edit-monan')) {
                    e.preventDefault();
                    const monAnId = e.target.getAttribute('data-id');
                    if (monAnId) {
                        document.querySelector('.menu-item[data-target="menuAddEdit"]').click();
                        loadMonAnDeSua(monAnId);
                    }
                }
                if (e.target && e.target.classList.contains('btn-delete-monan-list')) {
                    e.preventDefault();
                    const monAnId = e.target.getAttribute('data-id');
                    if (!monAnId) {
                        alert("Lỗi: Không tìm thấy ID Món ăn."); return;
                    }
                    if (!confirm(`Bạn có chắc muốn xóa vĩnh viễn món ăn ID: ${monAnId}?`)) return;

                    try {
                        const response = await fetch(`/api/monan/${monAnId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            await loadMonAnList();
                            const filteredData = getFilteredMonAnData();
                            renderMonAnListAndPagination(filteredData, 1);
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.closest('#monan-pagination') && e.target.tagName === 'BUTTON') {
                    e.preventDefault();
                    const pageNumber = parseInt(e.target.getAttribute('data-page'), 10);
                    if (!isNaN(pageNumber) && pageNumber > 0) {
                        const filteredData = getFilteredMonAnData();
                        renderMonAnListAndPagination(filteredData, pageNumber);
                    }
                }

                // --- Sự kiện cho NGUYÊN LIỆU ---
               function getNguyenLieuFormData() {
                    return {
                        TenNl: document.getElementById('nguyenlieu-name').value,
                        DonVi: document.getElementById('nguyenlieu-unit').value,
                        Loai: document.getElementById('nguyenlieu-type').value,
                        SoLuong: parseInt(document.getElementById('nguyenlieu-quantity').value, 10) || 0,
                        NgayNhap: document.getElementById('nguyenlieu-date').value || null,
                        HinhAnh: document.getElementById('nguyenlieu-image').value
                    };
                }
                if (e.target && e.target.id === 'btn-save-nguyenlieu') {
                    e.preventDefault();
                    const data = getNguyenLieuFormData();
                    if (!data.TenNl || !data.DonVi || !data.Loai) {
                        alert('Vui lòng nhập Tên, Đơn vị tính và Loại!'); return;
                    }
                    try {
                        const response = await fetch('/api/nguyenlieu', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="nguyenLieuList"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-update-nguyenlieu') {
                    e.preventDefault();
                    const nguyenLieuId = document.getElementById('nguyenlieu-id').value;
                    if (!nguyenLieuId) {
                        alert("Lỗi: Không tìm thấy ID Nguyên liệu để cập nhật."); return;
                    }
                    const data = getNguyenLieuFormData();
                    if (!data.TenNl || !data.DonVi || !data.Loai) {
                        alert('Vui lòng nhập Tên, Đơn vị tính và Loại!'); return;
                    }
                    try {
                        const response = await fetch(`/api/nguyenlieu/${nguyenLieuId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="nguyenLieuList"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.id === 'btn-delete-nguyenlieu') {
                    e.preventDefault();
                    const nguyenLieuId = document.getElementById('nguyenlieu-id').value;
                    if (!nguyenLieuId) {
                        alert("Lỗi: Không tìm thấy ID Nguyên liệu để xóa."); return;
                    }
                    if (!confirm(`Bạn có chắc muốn xóa vĩnh viễn nguyên liệu ID: ${nguyenLieuId}?`)) return;
                    try {
                        const response = await fetch(`/api/nguyenlieu/${nguyenLieuId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            document.querySelector('.menu-item[data-target="nguyenLieuList"]').click();
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.classList.contains('btn-edit-nguyenlieu')) {
                    e.preventDefault();
                    const nguyenLieuId = e.target.getAttribute('data-id');
                    if (nguyenLieuId) {
                        document.querySelector('.menu-item[data-target="nguyenLieuAddEdit"]').click();
                        loadNguyenLieuDeSua(nguyenLieuId);
                    }
                }
                if (e.target && e.target.classList.contains('btn-delete-nguyenlieu-list')) {
                    e.preventDefault();
                    const nguyenLieuId = e.target.getAttribute('data-id');
                    if (!nguyenLieuId) {
                        alert("Lỗi: Không tìm thấy ID Nguyên liệu."); return;
                    }
                    if (!confirm(`Bạn có chắc muốn xóa vĩnh viễn nguyên liệu ID: ${nguyenLieuId}?`)) return;
                    try {
                        const response = await fetch(`/api/nguyenlieu/${nguyenLieuId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message);
                            await loadNguyenLieuList();
                            const filteredData = getFilteredNguyenLieuData();
                            renderNguyenLieuListAndPagination(filteredData, 1);
                        } else {
                            alert('Lỗi: ' + result.message);
                        }
                    } catch (err) {
                        alert('Lỗi kết nối máy chủ: ' + err.message);
                    }
                }
                if (e.target && e.target.closest('#nguyenlieu-pagination') && e.target.tagName === 'BUTTON') {
                    e.preventDefault();
                    const pageNumber = parseInt(e.target.getAttribute('data-page'), 10);
                    if (!isNaN(pageNumber) && pageNumber > 0) {
                        const filteredData = getFilteredNguyenLieuData();
                        renderNguyenLieuListAndPagination(filteredData, pageNumber);
                    }
                }
                // --- ▲▲▲ KẾT THÚC SỬA CODE CHO NGUYÊN LIỆU ▲▲▲ ---

            });
        }
    }); // Hết DOMContentLoaded

    // --- PHẦN 4: TỰ ĐỘNG GỌI HÀM LOAD (KIỂM TRA URL) ---
    (function() {
        // (Code tự động load 'Edit' nhân viên - không đổi)
        const pathParts = window.location.pathname.split('/');
        const lastPart = pathParts[pathParts.length - 1];
        const secondLastPart = pathParts[pathParts.length - 2];
        if (secondLastPart && secondLastPart.toLowerCase() === 'edit' && !isNaN(lastPart)) {
            // (Code xử lý load edit nhân viên)
        }
    })();
</script>
